<link rel="import" href="../components/polymer/polymer.html">

<polymer-element name='pl-registry' constructor='Registry'>
<script>
Polymer('pl-registry', {
  // Registry keys are connections.
  keys: [],
  // Registry map entries list connection inputs and outputs.
  map: new WeakMap(),  
  ready: function() {
    new ArrayObserver(this.keys).open(function(splices) {
      splices.forEach(function(splice) {
        for (var i = 0; i < splice.addedCount; i++) {
          // fire events when the inputs and outputs of connections change.
          var update = function() {
            var key = this.keys[i + splice.index];
            var obj = this.map.get(key);
            new ArrayObserver(obj.input).open(
              function() { this.fire('connectionChanged', obj); }.bind(this));
            this.fire('connectionChanged', obj);
            new ArrayObserver(obj.output).open(
              function() { this.fire('connectionChanged', obj); }.bind(this));
            this.fire('connectionChanged', obj);
          }.bind(this);
          update();
        }
      }.bind(this));
    }.bind(this));
  },
  _update: function(pipe, element, name, isInput) {
    if (this.map.get(pipe) !== undefined) {
      var rec = this.map.get(pipe);
    } else {
      var rec = {input: [], output: [], impl: undefined};
      this.map.set(pipe, rec);
      this.keys.push(pipe);
    }
    if (isInput) {
      list = rec.input;
    } else {
      list = rec.output;
    }
    for (var i = 0; i < list.length; i++) {
      if (list[i].element == element && list[i].name == name) {
        return list[i];
      }
    }
    var newEntry = {element: element, name: name};
    list.push(newEntry);
    return newEntry;
  },
  registerInput: function(pipe, element, name) { return this._update(pipe, element, name, true); },
  registerOutput: function(pipe, element, name) { return this._update(pipe, element, name, false); },
  addElement: function(element) {
    for (input in element.inputs) {
      this.registerInput(element.inputs[input], element, input);
    }
    for (output in element.outputs) {
      this.registerOutput(element.outputs[output], element, output);
    }
    element.addEventListener('inputChanged', function(e) {
      this.registerInput(e.detail.pipe, element, e.detail.name);
    }.bind(this));
    element.addEventListener('outputChanged', function(e) {
      this.registerOutput(e.detail.pipe, element, e.detail.name);
    }.bind(this));
  }

 
});
</script>
</polymer-element>
